<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BIBIMAKE ã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--navy:#1B3A5C;--navy-dark:#122842;--accent:#3A7CA5;--accent-light:#5BA3CC;--bg:#F4F7FA;--card:#FFF;--text:#2C3E50;--text-light:#7B8FA3;--border:#E2E8F0;--early-bg:#E8F5E9;--early-fg:#2E7D32;--late-bg:#FFF3E0;--late-fg:#E65100;--off-bg:#FFEBEE;--off-fg:#C62828;--loc-bg:#E3F2FD;--loc-fg:#1565C0;--study-bg:#F3E5F5;--study-fg:#7B1FA2;--event-bg:#E0F7FA;--event-fg:#00838F;--shadow-sm:0 1px 3px rgba(0,0,0,.08);--shadow-md:0 4px 12px rgba(0,0,0,.1);--shadow-lg:0 8px 30px rgba(0,0,0,.12);--radius:12px;--radius-sm:8px}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans JP','Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(18,40,66,.7);backdrop-filter:blur(8px);z-index:9999;display:flex;align-items:center;justify-content:center;transition:opacity .4s}.login-overlay.hidden{opacity:0;pointer-events:none}
.login-box{background:#fff;border-radius:16px;padding:36px;width:340px;max-width:90vw;box-shadow:0 20px 60px rgba(0,0,0,.25);text-align:center}
.login-logo{width:52px;height:52px;background:var(--accent);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;font-family:Outfit;color:#fff;margin:0 auto 12px}
.login-title{font-family:Outfit;font-size:20px;font-weight:700;color:var(--navy);margin-bottom:4px}.login-sub{font-size:12px;color:var(--text-light);margin-bottom:20px}
.login-input{width:100%;padding:11px 14px;border:2px solid var(--border);border-radius:10px;font-size:14px;font-family:inherit;outline:none;transition:.2s;text-align:center;letter-spacing:2px}.login-input:focus{border-color:var(--accent)}.login-input.shake{border-color:#EF5350;animation:shake .4s}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
.login-btn{width:100%;padding:11px;border:none;border-radius:10px;background:var(--navy);color:#fff;font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;margin-top:12px;transition:.2s}.login-btn:hover{background:var(--accent)}
.login-error{color:#EF5350;font-size:11px;margin-top:8px;min-height:16px}
.header{background:linear-gradient(135deg,var(--navy),var(--navy-dark));color:#fff;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-md)}
.header-inner{max-width:1300px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.logo{display:flex;align-items:center;gap:10px}.logo-icon{width:36px;height:36px;background:var(--accent);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;font-family:Outfit}
.logo-text{font-family:Outfit;font-size:19px;font-weight:600;letter-spacing:1px}.logo-sub{font-size:10px;opacity:.6;letter-spacing:2px}
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.month-nav{display:flex;align-items:center;gap:6px}
.month-nav button{width:32px;height:32px;border:1px solid rgba(255,255,255,.2);background:0 0;color:#fff;border-radius:7px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:.2s}.month-nav button:hover{background:rgba(255,255,255,.1)}
.m-label{font-family:Outfit;font-size:15px;font-weight:600;min-width:110px;text-align:center}
.mode-toggle{display:flex;background:rgba(255,255,255,.1);border-radius:7px;overflow:hidden}
.mode-btn{padding:6px 14px;border:none;background:0 0;color:rgba(255,255,255,.5);font-size:11px;font-weight:500;cursor:pointer;transition:.3s;font-family:inherit}.mode-btn.active{background:var(--accent);color:#fff}
.btn-logout{background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.2);padding:5px 10px;font-size:10px;border-radius:6px;cursor:pointer;font-family:inherit;display:none}.btn-logout:hover{background:rgba(255,255,255,.25)}
.a-badge{background:rgba(76,175,80,.2);color:#81C784;font-size:9px;font-weight:600;padding:2px 7px;border-radius:10px;margin-left:3px;display:none}
.main{max-width:1300px;margin:0 auto;padding:18px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:16px}
.stat{background:var(--card);border-radius:var(--radius-sm);padding:12px 8px;box-shadow:var(--shadow-sm);text-align:center}
.stat-v{font-family:Outfit;font-size:22px;font-weight:700;color:var(--navy)}.stat-l{font-size:10px;color:var(--text-light);margin-top:2px}
.cal-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-sm);overflow:hidden;margin-bottom:16px}
.cal-h{display:grid;grid-template-columns:repeat(7,1fr);background:var(--navy);color:#fff}
.cal-h div{padding:10px 6px;text-align:center;font-size:12px;font-weight:600}.cal-h div:first-child{color:#FF8A80}.cal-h div:last-child{color:#82B1FF}
.cal-g{display:grid;grid-template-columns:repeat(7,1fr)}
.cal-c{min-height:105px;border:1px solid var(--border);padding:4px;transition:.15s}
.cal-c:hover{background:#F8FAFC}.cal-c.empty{background:#FAFAFA}.cal-c.sun{background:#FFF5F5}.cal-c.sat{background:#F5F8FF}.cal-c.today{box-shadow:inset 0 0 0 2px var(--accent)}
.cal-c.editable{cursor:pointer}.cal-c.editable:hover{background:#EDF5FF;box-shadow:inset 0 0 0 1px var(--accent)}
.cd{font-family:Outfit;font-size:12px;font-weight:700;margin-bottom:3px;display:flex;justify-content:space-between}.cal-c.sun .cd{color:#EF5350}.cal-c.sat .cd{color:#42A5F5}
.cd-n{font-size:9px;background:var(--navy);color:#fff;padding:1px 5px;border-radius:8px}
.tg{display:block;padding:1px 4px;border-radius:3px;font-size:9.5px;font-weight:600;margin:1px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tg-e{background:var(--early-bg);color:var(--early-fg)}.tg-l{background:var(--late-bg);color:var(--late-fg)}.tg-o{background:var(--off-bg);color:var(--off-fg)}
.tg-loc{background:var(--loc-bg);color:var(--loc-fg)}.tg-st{background:var(--study-bg);color:var(--study-fg)}
.tg-ev{background:#E0F7FA;color:#00695C;border-left:2px solid #00897B;font-weight:700}
.legend{display:flex;gap:10px;padding:10px 14px;background:#F8FAFC;border-top:1px solid var(--border);flex-wrap:wrap}
.lg{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text-light)}.lg-d{width:10px;height:10px;border-radius:3px}
.admin-only{display:none}.admin-only.show{display:block}
.sc{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-sm);overflow:hidden;margin-bottom:16px}
.sc-h{padding:12px 16px;border-bottom:1px solid var(--border);font-weight:600;color:var(--navy);font-size:13px}
.sc-b{padding:14px 16px}
.loc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
.loc-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:7px;background:var(--bg)}
.loc-dot{width:8px;height:8px;border-radius:50%}.loc-name{font-size:12px;font-weight:600}.loc-count{font-family:Outfit;font-size:17px;font-weight:700;color:var(--navy);margin-left:auto}
table.stbl{width:100%;border-collapse:collapse}table.stbl th{background:var(--navy);color:#fff;padding:8px;font-size:10px;text-align:center}
table.stbl th:first-child{text-align:left;padding-left:14px}table.stbl td{padding:8px;border-bottom:1px solid var(--border);font-size:11px;text-align:center}
table.stbl td:first-child{text-align:left;padding-left:14px;font-weight:600}table.stbl tr:nth-child(even){background:#FAFBFC}
.bar{height:5px;border-radius:3px;background:var(--border);position:relative;min-width:40px}.bar-f{height:100%;border-radius:3px;position:absolute;left:0;top:0}
.csv-zone{border:2px dashed var(--border);border-radius:10px;padding:20px;text-align:center;transition:.2s;cursor:pointer;margin-bottom:10px}
.csv-zone:hover,.csv-zone.drag{border-color:var(--accent);background:rgba(58,124,165,.05)}
.csv-zone-icon{font-size:28px;margin-bottom:6px}.csv-zone-text{font-size:12px;color:var(--text-light)}.csv-zone-sub{font-size:10px;color:var(--text-light);margin-top:3px}
.csv-status{padding:8px 12px;border-radius:7px;font-size:11px;margin-top:8px;display:none}
.csv-status.ok{display:block;background:var(--early-bg);color:var(--early-fg)}.csv-status.err{display:block;background:var(--off-bg);color:var(--off-fg)}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:5000;display:flex;align-items:center;justify-content:center;transition:opacity .3s}.modal-overlay.hidden{opacity:0;pointer-events:none}
.modal{background:#fff;border-radius:14px;padding:22px;width:420px;max-width:92vw;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal-title{font-size:15px;font-weight:700;color:var(--navy);margin-bottom:14px}
.modal-row{margin-bottom:8px}.modal-label{font-size:10px;font-weight:600;color:var(--text-light);margin-bottom:3px}
.modal-select{width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:inherit}.modal-select:focus{outline:none;border-color:var(--accent)}
.modal-btns{display:flex;gap:8px;margin-top:14px;justify-content:flex-end}
.ev-row{display:flex;gap:6px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
.ev-row input{padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:11px;font-family:inherit}.ev-row input:focus{outline:none;border-color:var(--accent)}
.ev-row input[type=date]{width:130px}.ev-row input[type=text]{flex:1;min-width:120px}
.ev-item{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border-radius:6px;background:var(--bg);margin-bottom:5px;font-size:11px}
.btn{padding:6px 14px;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:.2s;font-family:inherit;display:inline-flex;align-items:center;gap:4px}
.btn-p{background:var(--accent);color:#fff}.btn-p:hover{background:var(--accent-light)}
.btn-s{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-d{background:var(--off-bg);color:var(--off-fg);border:none;padding:3px 8px;font-size:10px;border-radius:4px;cursor:pointer}
.toast{position:fixed;bottom:20px;right:20px;background:var(--navy);color:#fff;padding:11px 20px;border-radius:var(--radius-sm);font-size:12px;box-shadow:var(--shadow-lg);transform:translateY(100px);opacity:0;transition:.4s cubic-bezier(.22,1,.36,1);z-index:8000}.toast.show{transform:translateY(0);opacity:1}
.data-badge{display:inline-block;font-size:9px;padding:2px 8px;border-radius:10px;font-weight:600;margin-left:6px}.data-badge.has{background:var(--early-bg);color:var(--early-fg)}.data-badge.no{background:var(--off-bg);color:var(--off-fg)}
@media(max-width:768px){.main{padding:12px}.cal-c{min-height:70px;padding:3px}.tg{font-size:8.5px}.stats{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="login-overlay hidden" id="loginOv"><div class="login-box"><div class="login-logo">B</div><div class="login-title">BIBIMAKE</div><div class="login-sub">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
<form onsubmit="return doLogin()"><input type="password" class="login-input" id="loginPw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off"><div class="login-error" id="loginErr"></div><button type="submit" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button></form></div></div>

<div class="modal-overlay hidden" id="editOv"><div class="modal" id="editModal"></div></div>

<header class="header"><div class="header-inner">
<div class="logo"><div class="logo-icon">B</div><div><div class="logo-text">BIBIMAKE</div><div class="logo-sub">Shift Calendar</div></div></div>
<div class="nav">
<div class="month-nav"><button onclick="chgM(-1)">â—€</button><span class="m-label" id="mL"></span><button onclick="chgM(1)">â–¶</button></div>
<div class="mode-toggle"><button class="mode-btn active" id="bS" onclick="setMode('staff')">ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•</button><button class="mode-btn" id="bA" onclick="reqAdmin()">ğŸ”’ ç®¡ç†è€…<span class="a-badge" id="aB">âœ“</span></button></div>
<button class="btn-logout" id="logoutBtn" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div></div></header>

<main class="main">
<div class="stats" id="stats"></div>
<div class="cal-card"><div class="cal-h"><div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div></div><div class="cal-g" id="cG"></div>
<div class="legend" id="leg"></div></div>

<div class="admin-only" id="adminS">
<div class="sc"><div class="sc-h">ğŸ“¥ CSVãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ <span class="data-badge" id="dataBadge"></span></div><div class="sc-b">
<div class="csv-zone" id="csvZone" onclick="document.getElementById('csvFile').click()">
<div class="csv-zone-icon">ğŸ“„</div>
<div class="csv-zone-text">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— or ã‚¯ãƒªãƒƒã‚¯</div>
<div class="csv-zone-sub">Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ â†’ ãƒ•ã‚¡ã‚¤ãƒ« â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â†’ CSV</div>
</div>
<input type="file" id="csvFile" accept=".csv" style="display:none" onchange="handleCSV(this.files[0])">
<div class="csv-status" id="csvSt"></div>
</div></div>

<div class="sc"><div class="sc-h">ğŸ“ æ•™å®¤åˆ¥ æœˆé–“å‡ºå‹¤äººæ•°</div><div class="sc-b"><div class="loc-grid" id="locG"></div></div></div>
<div class="sc"><div class="sc-h">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•åˆ¥ã‚µãƒãƒªãƒ¼</div><div class="sc-b" style="padding:0;overflow-x:auto"><table class="stbl" id="sTbl"></table></div></div>
<div class="sc"><div class="sc-h">ğŸŒ ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</div><div class="sc-b">
<div class="ev-row"><input type="date" id="evD"><input type="text" id="evT" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆä¾‹ï¼šå‹‰å¼·ä¼šã€ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ç ”ä¿®ï¼‰"><button class="btn btn-p" onclick="addEv()">ï¼‹è¿½åŠ </button></div>
<div id="evList"></div></div></div>
</div></main>
<div class="toast" id="toast"></div>

<script>
const ST=["ã¡ã‹","ã¿ã","ãˆã‚Š","ã˜ã‚…ã‚“ã“","ã¿ã¿","ã‚†ã‹ã‚Š","ã‘ã„ã“","ã•ã","ã‚ã„ã‹","ã‚ã‚„ã‹"];
const SC=["#E91E63","#9C27B0","#2196F3","#FF9800","#4CAF50","#00BCD4","#795548","#F44336","#3F51B5","#8BC34A"];
const LOCS=["æ±äº¬æœ¬éƒ¨","æ–°å®¿","æ¨ªæµœ","å¤§é˜ª","ç¦å²¡"];const LC=["#4A90D9","#7B68EE","#20B2AA","#FF7F50","#DA70D6"];
const DW=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];const PW="bibi";
let cY=2026,cM=3,isA=false,mode="staff",allData={},events={};

// Pre-load March
allData["2026-03"]={
"ã¡ã‹":["","","æ–°å®¿","","","","","","","æ—©","","","","","","","æ–°å®¿","","","","","","","æ—©","æ–°å®¿","","æ–°å®¿","","","","æ–°å®¿"],
"ã¿ã":["é…","","æ—©","æ¨ªæµœ","","","é…","é…","","æ¨ªæµœ","æ¨ªæµœ","é…","","","é…","æ—©","æ—©","","","","","","","é…","æ¨ªæµœ","é…","æ¨ªæµœ","","","","æ¨ªæµœ"],
"ãˆã‚Š":["","æ¨ªæµœ","é…","å‹‰å¼·ä¼š","","","","","æ—©","é…","æ—©","","","","","æ¨ªæµœ","é…","","","","","","æ¨ªæµœ","æ–°å®¿","æ—©","","æ–°å®¿","","","é…","é…"],
"ã˜ã‚…ã‚“ã“":["","é…","","","","","","","é…","","","","","","","é…","","","","","é…","","é…","","","","","","","",""],
"ã¿ã¿":["ä¼‘","å¤§é˜ª","æ±äº¬æœ¬éƒ¨","æ±äº¬æœ¬éƒ¨","","","ä¼‘","","å¤§é˜ª","æ±äº¬æœ¬éƒ¨","æ±äº¬æœ¬éƒ¨","æ±äº¬æœ¬éƒ¨","","","ä¼‘","å‹‰å¼·ä¼š","æ±äº¬æœ¬éƒ¨","","","å‹‰å¼·ä¼š","","","å‹‰å¼·ä¼š","æ±äº¬æœ¬éƒ¨","é…","æ±äº¬æœ¬éƒ¨","é…","","","æ¨ªæµœ","æ±äº¬æœ¬éƒ¨"],
"ã‚†ã‹ã‚Š":["","æ—©","","æ–°å®¿","","","æ–°å®¿","","ä¼‘","æ–°å®¿","æ–°å®¿","æ–°å®¿","","","","ä¼‘","","","ä¼‘","ä¼‘","","æ—©","","æ±äº¬æœ¬éƒ¨","","","","","","æ—©",""],
"ã‘ã„ã“":["æ±äº¬æœ¬éƒ¨","æ±äº¬æœ¬éƒ¨","","å‹‰å¼·ä¼š","","","æ¨ªæµœ","æ±äº¬æœ¬éƒ¨","æ¨ªæµœ","","é…","","","","æ±äº¬æœ¬éƒ¨","","","","","å‹‰å¼·ä¼š","","","å¤§é˜ª","å¤§é˜ª","å¤§é˜ª","æ—©","æ—©","","","æ±äº¬æœ¬éƒ¨","æ—©"],
"ã•ã":["","","","é…","","","æ±äº¬æœ¬éƒ¨","æ—©","æ±äº¬æœ¬éƒ¨","","","","","","","","","","","å‹‰å¼·ä¼š","","","","","","","","","","",""],
"ã‚ã„ã‹":["æ—©","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
"ã‚ã‚„ã‹":["","","","æ—©","","","æ—©","","","","","æ—©","","","æ—©","","","","","å‹‰å¼·ä¼š","","","","","","","","","","",""]
};

function gV(n,d){const k=`${cY}-${String(cM).padStart(2,"0")}`;return allData[k]?.[n]?.[d-1]||""}
function sV(n,d,v){const k=`${cY}-${String(cM).padStart(2,"0")}`;if(!allData[k])allData[k]={};if(!allData[k][n])allData[k][n]=Array(new Date(cY,cM,0).getDate()).fill("");allData[k][n][d-1]=v}
function classify(v){if(!v)return null;if(v==="æ—©")return{t:"e",l:"æ—©ç•ª"};if(v==="é…")return{t:"l",l:"é…ç•ª"};if(v==="ä¼‘")return{t:"o",l:"ä¼‘"};if(v==="å‹‰å¼·ä¼š")return{t:"s",l:"å‹‰å¼·ä¼š"};if(v.startsWith("æ—©"))return{t:"e",l:"æ—©ç•ª",loc:v.slice(1)};if(v.startsWith("é…"))return{t:"l",l:"é…ç•ª",loc:v.slice(1)};if(LOCS.includes(v))return{t:"loc",l:v,loc:v};return{t:"loc",l:v,loc:v}}
function getEv(d){return events[`${cY}-${String(cM).padStart(2,"0")}-${String(d).padStart(2,"0")}`]||[]}
function hasMonthData(){return!!allData[`${cY}-${String(cM).padStart(2,"0")}`]}

// Auth
function reqAdmin(){if(isA){setMode("admin");return}document.getElementById("loginOv").classList.remove("hidden");document.getElementById("loginPw").value="";document.getElementById("loginErr").textContent="";setTimeout(()=>document.getElementById("loginPw").focus(),100)}
function doLogin(){if(document.getElementById("loginPw").value===PW){isA=true;document.getElementById("loginOv").classList.add("hidden");document.getElementById("aB").style.display="inline";document.getElementById("logoutBtn").style.display="inline-block";setMode("admin");toast("âœ… ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†")}else{document.getElementById("loginPw").classList.add("shake");document.getElementById("loginErr").textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";setTimeout(()=>document.getElementById("loginPw").classList.remove("shake"),400)}return false}
function doLogout(){isA=false;document.getElementById("aB").style.display="none";document.getElementById("logoutBtn").style.display="none";setMode("staff");toast("ğŸ”’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ")}
document.addEventListener("keydown",e=>{if(e.key==="Escape"){document.getElementById("loginOv").classList.add("hidden");document.getElementById("editOv").classList.add("hidden")}});
["loginOv","editOv"].forEach(id=>document.getElementById(id).addEventListener("click",e=>{if(e.target===e.currentTarget)e.currentTarget.classList.add("hidden")}));

function setMode(m){if(m==="admin"&&!isA){reqAdmin();return}mode=m;document.getElementById("bS").classList.toggle("active",m==="staff");document.getElementById("bA").classList.toggle("active",m==="admin");document.getElementById("adminS").classList.toggle("show",m==="admin");render()}
function chgM(d){cM+=d;if(cM>12){cM=1;cY++}if(cM<1){cM=12;cY--}render()}

// CSV
const cz=document.getElementById("csvZone");
cz.addEventListener("dragover",e=>{e.preventDefault();cz.classList.add("drag")});
cz.addEventListener("dragleave",()=>cz.classList.remove("drag"));
cz.addEventListener("drop",e=>{e.preventDefault();cz.classList.remove("drag");if(e.dataTransfer.files.length)handleCSV(e.dataTransfer.files[0])});

function parseCSVLine(line){const r=[];let c="",q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"')q=!q;else if(ch===","&&!q){r.push(c);c=""}else c+=ch}r.push(c);return r}

function handleCSV(file){
  if(!file)return;const reader=new FileReader();
  reader.onload=function(e){
    try{
      const lines=e.target.result.split(/\r?\n/);
      let hi=-1;for(let i=0;i<Math.min(lines.length,5);i++){if(lines[i].includes("ã‚¹ã‚¿ãƒƒãƒ•")){hi=i;break}}
      if(hi===-1){csvSt("err","âŒ ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return}
      let dY=cY,dM=cM;const ym=(lines[0]||"").match(/(\d{4})å¹´(\d{1,2})æœˆ/);
      if(ym){dY=parseInt(ym[1]);dM=parseInt(ym[2])}
      const k=`${dY}-${String(dM).padStart(2,"0")}`;const dim=new Date(dY,dM,0).getDate();
      if(!allData[k])allData[k]={};
      let imp=0;
      for(let i=hi+1;i<lines.length;i++){
        const cols=parseCSVLine(lines[i]);if(cols.length<3)continue;
        const nm=cols[0].trim();if(!ST.includes(nm))continue;
        if(nm==="åˆè¨ˆ"||nm.includes("äººæ•°")||nm.includes("ğŸ“"))break;
        const sh=[];for(let d=0;d<dim;d++)sh.push((cols[d+2]||"").replace(/\n/g,"").trim());
        allData[k][nm]=sh;imp++;
      }
      if(imp>0){cY=dY;cM=dM;csvSt("ok",`âœ… ${dY}å¹´${dM}æœˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${imp}åï¼‰`);render();toast(`ğŸ“¥ ${dM}æœˆã®ã‚·ãƒ•ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ`)}
      else csvSt("err","âŒ ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    }catch(err){csvSt("err","âŒ èª­ã¿è¾¼ã¿å¤±æ•—: "+err.message)}
  };reader.readAsText(file,"UTF-8");
}
function csvSt(t,m){const el=document.getElementById("csvSt");el.className="csv-status "+t;el.textContent=m}

// Edit
function openEdit(day){
  if(!isA)return;const m=document.getElementById("editModal");const dow=new Date(cY,cM-1,day).getDay();
  const opts=["","æ—©","é…","ä¼‘","å‹‰å¼·ä¼š","æ—©æ±äº¬æœ¬éƒ¨","æ—©æ–°å®¿","æ—©æ¨ªæµœ","æ—©å¤§é˜ª","æ—©ç¦å²¡","é…æ±äº¬æœ¬éƒ¨","é…æ–°å®¿","é…æ¨ªæµœ","é…å¤§é˜ª","é…ç¦å²¡","æ±äº¬æœ¬éƒ¨","æ–°å®¿","æ¨ªæµœ","å¤§é˜ª","ç¦å²¡"];
  const labels={"":"â”€","æ—©":"æ—©ç•ª","é…":"é…ç•ª","ä¼‘":"ä¼‘ã¿","å‹‰å¼·ä¼š":"å‹‰å¼·ä¼š","æ—©æ±äº¬æœ¬éƒ¨":"æ—©ç•ª@æ±äº¬æœ¬éƒ¨","æ—©æ–°å®¿":"æ—©ç•ª@æ–°å®¿","æ—©æ¨ªæµœ":"æ—©ç•ª@æ¨ªæµœ","æ—©å¤§é˜ª":"æ—©ç•ª@å¤§é˜ª","æ—©ç¦å²¡":"æ—©ç•ª@ç¦å²¡","é…æ±äº¬æœ¬éƒ¨":"é…ç•ª@æ±äº¬æœ¬éƒ¨","é…æ–°å®¿":"é…ç•ª@æ–°å®¿","é…æ¨ªæµœ":"é…ç•ª@æ¨ªæµœ","é…å¤§é˜ª":"é…ç•ª@å¤§é˜ª","é…ç¦å²¡":"é…ç•ª@ç¦å²¡","æ±äº¬æœ¬éƒ¨":"æ±äº¬æœ¬éƒ¨","æ–°å®¿":"æ–°å®¿","æ¨ªæµœ":"æ¨ªæµœ","å¤§é˜ª":"å¤§é˜ª","ç¦å²¡":"ç¦å²¡"};
  let h=`<div class="modal-title">âœï¸ ${cM}æœˆ${day}æ—¥ï¼ˆ${DW[dow]}ï¼‰ã‚·ãƒ•ãƒˆç·¨é›†</div>`;
  ST.forEach((nm,i)=>{
    const v=gV(nm,day);
    h+=`<div class="modal-row"><div class="modal-label"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${SC[i]};margin-right:4px;vertical-align:middle"></span>${nm}</div><select class="modal-select" id="ed${i}" onchange="onEd(${i},${day})">`;
    opts.forEach(o=>{h+=`<option value="${o}"${v===o?" selected":""}>${labels[o]||o}</option>`});
    h+=`</select></div>`;
  });
  h+=`<div class="modal-btns"><button class="btn btn-s" onclick="document.getElementById('editOv').classList.add('hidden')">é–‰ã˜ã‚‹</button></div>`;
  m.innerHTML=h;document.getElementById("editOv").classList.remove("hidden");
}
function onEd(si,day){sV(ST[si],day,document.getElementById("ed"+si).value);render()}

// Events
function addEv(){const d=document.getElementById("evD").value,t=document.getElementById("evT").value.trim();if(!d||!t){toast("âš ï¸ æ—¥ä»˜ã¨ã‚¤ãƒ™ãƒ³ãƒˆåã‚’å…¥åŠ›");return}if(!events[d])events[d]=[];events[d].push(t);document.getElementById("evT").value="";toast("ğŸŒ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ");render()}
function rmEv(dk,i){events[dk].splice(i,1);if(!events[dk].length)delete events[dk];render()}

// Render
function render(){
  document.getElementById("mL").textContent=`${cY}å¹´ ${cM}æœˆ`;
  const dim=new Date(cY,cM,0).getDate(),fd=new Date(cY,cM-1,1).getDay(),td=new Date(),k=`${cY}-${String(cM).padStart(2,"0")}`;
  let tE=0,tL=0,tW=0,wd=0;const locC={};LOCS.forEach(l=>locC[l]=0);
  const ss={};ST.forEach(s=>ss[s]={w:0,e:0,l:0,st:0});
  const days=[];
  for(let d=1;d<=dim;d++){
    const dow=new Date(cY,cM-1,d).getDay(),isT=td.getFullYear()===cY&&td.getMonth()+1===cM&&td.getDate()===d;
    const evts=getEv(d),ent=[];let dc=0;
    ST.forEach((nm,si)=>{const v=gV(nm,d);if(!v)return;const info=classify(v);if(!info)return;ent.push({nm,si,info});
      if(info.t==="e"){dc++;tE++;ss[nm].w++;ss[nm].e++;if(info.loc&&locC[info.loc]!==undefined)locC[info.loc]++}
      else if(info.t==="l"){dc++;tL++;ss[nm].w++;ss[nm].l++;if(info.loc&&locC[info.loc]!==undefined)locC[info.loc]++}
      else if(info.t==="loc"){dc++;ss[nm].w++;if(locC[info.loc]!==undefined)locC[info.loc]++}
      else if(info.t==="s"){ss[nm].st++}});
    if(dc>0)wd++;tW+=dc;days.push({d,dow,isT,ent,dc,evts});
  }

  document.getElementById("stats").innerHTML=mode==="admin"?
    `<div class="stat"><div class="stat-v">${wd}</div><div class="stat-l">ç¨¼åƒæ—¥</div></div><div class="stat"><div class="stat-v">${ST.length}</div><div class="stat-l">ã‚¹ã‚¿ãƒƒãƒ•</div></div><div class="stat"><div class="stat-v">${tE}</div><div class="stat-l">æ—©ç•ª</div></div><div class="stat"><div class="stat-v">${tL}</div><div class="stat-l">é…ç•ª</div></div><div class="stat"><div class="stat-v">${tW}</div><div class="stat-l">ç·å‡ºå‹¤</div></div>`:
    `<div class="stat"><div class="stat-v">${wd}</div><div class="stat-l">ç¨¼åƒæ—¥</div></div><div class="stat"><div class="stat-v">${tE}</div><div class="stat-l">æ—©ç•ª</div></div><div class="stat"><div class="stat-v">${tL}</div><div class="stat-l">é…ç•ª</div></div>`;

  let h="";for(let i=0;i<fd;i++)h+=`<div class="cal-c empty"></div>`;
  days.forEach(({d,dow,isT,ent,dc,evts})=>{
    let cls="cal-c";if(dow===0)cls+=" sun";if(dow===6)cls+=" sat";if(isT)cls+=" today";
    if(isA)cls+=" editable";
    const click=isA?` onclick="openEdit(${d})"`:"";
    let tags="";
    evts.forEach(ev=>{tags+=`<div class="tg tg-ev">ğŸŒ ${ev}</div>`});
    if(mode==="staff"){
      const en=[],ln=[];ent.forEach(({nm,info})=>{if(info.t==="e")en.push(nm);if(info.t==="l")ln.push(nm)});
      if(en.length)tags+=`<div class="tg tg-e">â˜€ ${en.join("ãƒ»")}</div>`;
      if(ln.length)tags+=`<div class="tg tg-l">ğŸŒ™ ${ln.join("ãƒ»")}</div>`;
    }else{
      ent.forEach(({nm,info})=>{let t="",c="";
        if(info.t==="e"){c="tg-e";t=`â˜€${nm}${info.loc?" @"+info.loc:""}`}
        else if(info.t==="l"){c="tg-l";t=`ğŸŒ™${nm}${info.loc?" @"+info.loc:""}`}
        else if(info.t==="o"){c="tg-o";t=`${nm} ä¼‘`}
        else if(info.t==="s"){c="tg-st";t=`ğŸ“–${nm}`}
        else if(info.t==="loc"){c="tg-loc";t=`ğŸ“${nm}@${info.loc}`}
        tags+=`<div class="tg ${c}">${t}</div>`;
      });
    }
    const nb=dc>0?`<span class="cd-n">${dc}</span>`:"";
    h+=`<div class="${cls}"${click}><div class="cd"><span>${d}</span>${nb}</div>${tags}</div>`;
  });
  document.getElementById("cG").innerHTML=h;

  document.getElementById("leg").innerHTML=mode==="staff"?
    `<div class="lg"><div class="lg-d" style="background:var(--early-bg);border:1px solid #81C784"></div>æ—©ç•ª 9-15æ™‚</div><div class="lg"><div class="lg-d" style="background:var(--late-bg);border:1px solid #FFB74D"></div>é…ç•ª 12-18æ™‚</div><div class="lg"><div class="lg-d" style="background:var(--event-bg);border:1px solid #4DB6AC"></div>ã‚¤ãƒ™ãƒ³ãƒˆ</div>`:
    `<div class="lg"><div class="lg-d" style="background:var(--early-bg);border:1px solid #81C784"></div>æ—©ç•ª</div><div class="lg"><div class="lg-d" style="background:var(--late-bg);border:1px solid #FFB74D"></div>é…ç•ª</div><div class="lg"><div class="lg-d" style="background:var(--loc-bg);border:1px solid #64B5F6"></div>æ•™å®¤</div><div class="lg"><div class="lg-d" style="background:var(--study-bg);border:1px solid #BA68C8"></div>å‹‰å¼·ä¼š</div><div class="lg"><div class="lg-d" style="background:var(--off-bg);border:1px solid #EF9A9A"></div>ä¼‘ã¿</div><div class="lg"><div class="lg-d" style="background:var(--event-bg);border:1px solid #4DB6AC"></div>ã‚¤ãƒ™ãƒ³ãƒˆ</div><div class="lg" style="margin-left:auto;font-weight:600;color:var(--accent)">ğŸ“ æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†</div>`;

  if(mode==="admin"){
    const db=document.getElementById("dataBadge");db.className="data-badge "+(hasMonthData()?"has":"no");db.textContent=hasMonthData()?"ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š":"ãƒ‡ãƒ¼ã‚¿ãªã—";
    let lh="";LOCS.forEach((l,i)=>{lh+=`<div class="loc-item"><div class="loc-dot" style="background:${LC[i]}"></div><div class="loc-name">${l}</div><div class="loc-count">${locC[l]||0}</div></div>`});
    document.getElementById("locG").innerHTML=lh;
    const mx=Math.max(...ST.map(s=>ss[s].w),1);
    let th=`<thead><tr><th>ã‚¹ã‚¿ãƒƒãƒ•</th><th>å‡ºå‹¤</th><th>æ—©ç•ª</th><th>é…ç•ª</th><th>å‹‰å¼·ä¼š</th><th>ç¨¼åƒ</th></tr></thead><tbody>`;
    ST.forEach((n,i)=>{const s=ss[n];th+=`<tr><td><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${SC[i]};margin-right:5px;vertical-align:middle"></span>${n}</td><td><strong>${s.w}</strong></td><td style="color:var(--early-fg)">${s.e}</td><td style="color:var(--late-fg)">${s.l}</td><td style="color:var(--study-fg)">${s.st}</td><td><div class="bar"><div class="bar-f" style="width:${Math.round(s.w/mx*100)}%;background:${SC[i]}"></div></div></td></tr>`});
    document.getElementById("sTbl").innerHTML=th+"</tbody>";
    let eh="";Object.keys(events).sort().forEach(dk=>{if(!dk.startsWith(k))return;events[dk].forEach((ev,idx)=>{const day=parseInt(dk.split("-")[2]);eh+=`<div class="ev-item"><span>ğŸ“… ${cM}/${day}ï¼ˆ${DW[new Date(cY,cM-1,day).getDay()]}ï¼‰<strong>${ev}</strong></span><button class="btn-d" onclick="rmEv('${dk}',${idx})">âœ•</button></div>`})});
    document.getElementById("evList").innerHTML=eh||`<div style="color:var(--text-light);font-size:11px">ã‚¤ãƒ™ãƒ³ãƒˆãªã—</div>`;
    document.getElementById("evD").value=`${cY}-${String(cM).padStart(2,"0")}-01`;
  }
}

function toast(m){const t=document.getElementById("toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),3000)}
render();
</script>
</body>
</html>
